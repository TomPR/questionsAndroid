<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MainActivity.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debug</a> &gt; <a href="index.source.html" class="el_package">hk.ust.cse.hunkim.questionroom</a> &gt; <span class="el_source">MainActivity.java</span></div><h1>MainActivity.java</h1><pre class="source lang-java linenums">package hk.ust.cse.hunkim.questionroom;

import android.app.ListActivity;
import android.content.Intent;
import android.database.DataSetObserver;
import android.os.Bundle;
import android.util.Log;
import android.view.KeyEvent;
import android.view.View;
import android.view.inputmethod.EditorInfo;
import android.widget.EditText;
import android.widget.ListView;
import android.widget.TextView;
import android.widget.Toast;

import com.firebase.client.DataSnapshot;
import com.firebase.client.Firebase;
import com.firebase.client.FirebaseError;
import com.firebase.client.ValueEventListener;

import hk.ust.cse.hunkim.questionroom.db.DBHelper;
import hk.ust.cse.hunkim.questionroom.db.DBUtil;
import hk.ust.cse.hunkim.questionroom.question.Question;

<span class="pc bpc" id="L25" title="1 of 2 branches missed.">public class MainActivity extends ListActivity {</span>

    // TODO: change this to your own Firebase URL
    //private static final String FIREBASE_URL = &quot;https://blistering-inferno-5925.firebaseio.com/&quot;;
    private static final String FIREBASE_URL = &quot;https://questionsandroidtest.firebaseio.com/&quot;;

    private String roomName;
    private Firebase mFirebaseRef;
    private ValueEventListener mConnectedListener;
    private QuestionListAdapter mChatListAdapter;

    private DBUtil dbutil;

    public DBUtil getDbutil() {
<span class="fc" id="L39">        return dbutil;</span>
    }

    @Override
    protected void onCreate(Bundle savedInstanceState) {
<span class="fc" id="L44">        super.onCreate(savedInstanceState);</span>

        //initialized once with an Android context.
<span class="fc" id="L47">        Firebase.setAndroidContext(this);</span>

<span class="fc" id="L49">        setContentView(R.layout.activity_main);</span>

<span class="fc" id="L51">        Intent intent = getIntent();</span>
<span class="pc bpc" id="L52" title="3 of 4 branches missed.">        assert (intent != null);</span>

        // Make it a bit more reliable
<span class="fc" id="L55">        roomName = intent.getStringExtra(JoinActivity.ROOM_NAME);</span>
<span class="pc bpc" id="L56" title="1 of 4 branches missed.">        if (roomName == null || roomName.length() == 0) {</span>
<span class="fc" id="L57">            roomName = &quot;all&quot;;</span>
        }

<span class="fc" id="L60">        setTitle(&quot;Room name: &quot; + roomName);</span>

        // Setup our Firebase mFirebaseRef
<span class="fc" id="L63">        mFirebaseRef = new Firebase(FIREBASE_URL).child(roomName).child(&quot;questions&quot;);</span>

        // Setup our input methods. Enter key on the keyboard or pushing the send button
<span class="fc" id="L66">        EditText inputText = (EditText) findViewById(R.id.messageInput);</span>
<span class="fc" id="L67">        inputText.setOnEditorActionListener(new TextView.OnEditorActionListener() {</span>
            @Override
            public boolean onEditorAction(TextView textView, int actionId, KeyEvent keyEvent) {
<span class="nc bnc" id="L70" title="All 4 branches missed.">                if (actionId == EditorInfo.IME_NULL &amp;&amp; keyEvent.getAction() == KeyEvent.ACTION_DOWN) {</span>
<span class="nc" id="L71">                    sendMessage();</span>
                }
<span class="nc" id="L73">                return true;</span>
            }
        });

<span class="fc" id="L77">        findViewById(R.id.sendButton).setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View view) {
<span class="fc" id="L80">                sendMessage();</span>
<span class="fc" id="L81">            }</span>
        });

        // get the DB Helper
<span class="fc" id="L85">        DBHelper mDbHelper = new DBHelper(this);</span>
<span class="fc" id="L86">        dbutil = new DBUtil(mDbHelper);</span>
<span class="fc" id="L87">    }</span>

    @Override
    public void onStart() {
<span class="fc" id="L91">        super.onStart();</span>

        // Setup our view and list adapter. Ensure it scrolls to the bottom as data changes
<span class="fc" id="L94">        final ListView listView = getListView();</span>
        // Tell our list adapter that we only want 200 messages at a time
<span class="fc" id="L96">        mChatListAdapter = new QuestionListAdapter(</span>
<span class="fc" id="L97">                mFirebaseRef.orderByChild(&quot;echo&quot;).limitToFirst(200),</span>
                this, R.layout.question, roomName);
<span class="fc" id="L99">        listView.setAdapter(mChatListAdapter);</span>

<span class="fc" id="L101">        mChatListAdapter.registerDataSetObserver(new DataSetObserver() {</span>
            @Override
            public void onChanged() {
<span class="fc" id="L104">                super.onChanged();</span>
<span class="fc" id="L105">                listView.setSelection(mChatListAdapter.getCount() - 1);</span>
<span class="fc" id="L106">            }</span>
        });

        // Finally, a little indication of connection status
<span class="fc" id="L110">        mConnectedListener = mFirebaseRef.getRoot().child(&quot;.info/connected&quot;).addValueEventListener(new ValueEventListener() {</span>
            @Override
            public void onDataChange(DataSnapshot dataSnapshot) {
<span class="fc" id="L113">                boolean connected = (Boolean) dataSnapshot.getValue();</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">                if (connected) {</span>
<span class="fc" id="L115">                    Toast.makeText(MainActivity.this, &quot;Connected to Firebase&quot;, Toast.LENGTH_SHORT).show();</span>
                } else {
<span class="fc" id="L117">                    Toast.makeText(MainActivity.this, &quot;Disconnected from Firebase&quot;, Toast.LENGTH_SHORT).show();</span>
                }
<span class="fc" id="L119">            }</span>

            @Override
            public void onCancelled(FirebaseError firebaseError) {
                // No-op
<span class="nc" id="L124">            }</span>
        });
<span class="fc" id="L126">    }</span>

    @Override
    public void onStop() {
<span class="fc" id="L130">        super.onStop();</span>
<span class="fc" id="L131">        mFirebaseRef.getRoot().child(&quot;.info/connected&quot;).removeEventListener(mConnectedListener);</span>
<span class="fc" id="L132">        mChatListAdapter.cleanup();</span>
<span class="fc" id="L133">    }</span>

    private void sendMessage() {
<span class="fc" id="L136">        EditText inputText = (EditText) findViewById(R.id.messageInput);</span>
<span class="fc" id="L137">        String input = inputText.getText().toString();</span>
<span class="fc bfc" id="L138" title="All 2 branches covered.">        if (!input.equals(&quot;&quot;)) {</span>
            // Create our 'model', a Chat object
<span class="fc" id="L140">            Question question = new Question(input);</span>
            // Create a new, auto-generated child of that chat location, and save our chat data there
<span class="fc" id="L142">            mFirebaseRef.push().setValue(question);</span>
<span class="fc" id="L143">            inputText.setText(&quot;&quot;);</span>
        }
<span class="fc" id="L145">    }</span>

    public void updateEcho(String key) {
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">        if (dbutil.contains(key)) {</span>
<span class="nc" id="L149">            Log.e(&quot;Dupkey&quot;, &quot;Key is already in the DB!&quot;);</span>
<span class="nc" id="L150">            return;</span>
        }

<span class="fc" id="L153">        final Firebase echoRef = mFirebaseRef.child(key).child(&quot;echo&quot;);</span>
<span class="fc" id="L154">        echoRef.addListenerForSingleValueEvent(</span>
<span class="fc" id="L155">                new ValueEventListener() {</span>
                    @Override
                    public void onDataChange(DataSnapshot dataSnapshot) {
<span class="fc" id="L158">                        Long echoValue = (Long) dataSnapshot.getValue();</span>
<span class="fc" id="L159">                        Log.e(&quot;Echo update:&quot;, &quot;&quot; + echoValue);</span>

<span class="fc" id="L161">                        echoRef.setValue(echoValue + 1);</span>
<span class="fc" id="L162">                    }</span>

                    @Override
                    public void onCancelled(FirebaseError firebaseError) {

<span class="nc" id="L167">                    }</span>
                }
        );

<span class="fc" id="L171">        final Firebase orderRef = mFirebaseRef.child(key).child(&quot;order&quot;);</span>
<span class="fc" id="L172">        orderRef.addListenerForSingleValueEvent(</span>
<span class="fc" id="L173">                new ValueEventListener() {</span>
                    @Override
                    public void onDataChange(DataSnapshot dataSnapshot) {
<span class="fc" id="L176">                        Long orderValue = (Long) dataSnapshot.getValue();</span>
<span class="fc" id="L177">                        Log.e(&quot;Order update:&quot;, &quot;&quot; + orderValue);</span>

<span class="fc" id="L179">                        orderRef.setValue(orderValue - 1);</span>
<span class="fc" id="L180">                    }</span>

                    @Override
                    public void onCancelled(FirebaseError firebaseError) {

<span class="nc" id="L185">                    }</span>
                }
        );

        // Update SQLite DB
<span class="fc" id="L190">        dbutil.put(key);</span>
<span class="fc" id="L191">    }</span>

    public void Close(View view) {
<span class="fc" id="L194">        finish();</span>
<span class="fc" id="L195">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>